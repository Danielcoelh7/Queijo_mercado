<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Emp√≥rio do Queijo & Cia</title>
    <style>
        /* =========================================
           1. VARI√ÅVEIS E TEMA (CHEESE THEME)
           ========================================= */
        :root {
            --primary: #FFC107;      /* Amarelo Ouro */
            --primary-dark: #F57F17; /* Laranja Queijo Forte */
            --accent: #2E7D32;       /* Verde Sucesso */
            --danger: #D32F2F;       /* Vermelho Erro */
            --bg-body: #FFF8E1;      /* Creme Suave */
            --bg-card: #FFFFFF;
            --text-main: #3E2723;    /* Marrom Caf√© */
            --text-light: #5D4037;
            --shadow: 0 4px 15px rgba(0,0,0,0.1);
            --radius: 16px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: 'Segoe UI', system-ui, sans-serif; 
            background-color: var(--bg-body); 
            color: var(--text-main); 
            line-height: 1.5;
            padding-bottom: 120px; /* Espa√ßo para footer e bot√£o flutuante */
        }

        input, button { font-family: inherit; font-size: 1rem; }
        .container { max-width: 1000px; margin: 0 auto; padding: 0 16px; }

        /* =========================================
           2. TOASTS (NOTIFICA√á√ïES)
           ========================================= */
        #toast-container {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 3000; width: 90%; max-width: 400px; pointer-events: none;
        }

        .toast {
            background: #333; color: #fff; padding: 12px 20px;
            border-radius: 50px; margin-bottom: 10px; text-align: center;
            opacity: 0; transform: translateY(-20px); transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); font-weight: 600;
        }
        .toast.visible { opacity: 1; transform: translateY(0); }
        .toast.success { background-color: var(--accent); }
        .toast.error { background-color: var(--danger); }
        .toast.info { background-color: var(--primary-dark); }

        /* =========================================
           3. MODAL DE NOTA (RECIBO)
           ========================================= */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center;
            z-index: 2000; padding: 20px; backdrop-filter: blur(4px);
        }
        .modal-overlay.open { display: flex; animation: fadeIn 0.2s; }
        
        .modal-card {
            background: white; width: 100%; max-width: 480px;
            border-radius: var(--radius); box-shadow: 0 10px 40px rgba(0,0,0,0.4);
            overflow: hidden; display: flex; flex-direction: column; max-height: 90vh;
        }

        .modal-header {
            background: var(--primary); padding: 15px; text-align: center;
            font-weight: 800; color: var(--text-main); font-size: 1.2rem;
        }

        .receipt-paper {
            background: #FFF9C4; padding: 20px;
            font-family: 'Courier New', Courier, monospace; font-size: 0.9rem;
            color: #333; overflow-y: auto; white-space: pre-wrap;
            border-bottom: 2px dashed #FBC02D;
        }

        .modal-actions {
            padding: 15px; background: white; display: flex; flex-direction: column; gap: 10px;
        }

        .btn-modal {
            padding: 12px; border: none; border-radius: 12px;
            font-weight: bold; cursor: pointer; font-size: 1rem;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-whatsapp { background: #25D366; color: white; }
        .btn-copy { background: #E0E0E0; color: #333; }
        .btn-close { background: transparent; color: var(--danger); border: 1px solid var(--danger); }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* =========================================
           4. CABE√áALHO E NAVEGA√á√ÉO
           ========================================= */
        .header {
            background: var(--primary); padding: 20px 0; text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000;
        }
        .header-title { color: var(--text-main); font-size: 1.8rem; font-weight: 900; letter-spacing: -1px; }
        .header-subtitle { font-size: 0.9rem; color: #5D4037; font-weight: 600; opacity: 0.9; }

        /* Barra de Busca */
        .search-section { padding: 20px 0 10px 0; }
        .search-input {
            width: 100%; padding: 14px 20px; border: 2px solid transparent;
            border-radius: 30px; background: white; box-shadow: var(--shadow);
            outline: none; transition: border 0.3s;
        }
        .search-input:focus { border-color: var(--primary-dark); }

        /* Categorias (Pills Horizontais) */
        .category-scroll {
            display: flex; gap: 10px; overflow-x: auto; padding: 10px 4px 20px 4px;
            scrollbar-width: none; /* Firefox */
        }
        .category-scroll::-webkit-scrollbar { display: none; /* Chrome */ }

        .category-pill {
            background: white; padding: 8px 16px; border-radius: 20px;
            white-space: nowrap; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            font-weight: 600; color: var(--text-light); cursor: pointer;
            border: 2px solid transparent; transition: all 0.2s;
        }
        .category-pill.active {
            background: var(--primary); color: var(--text-main);
            border-color: var(--primary-dark); transform: scale(1.05);
        }

        /* =========================================
           5. CAT√ÅLOGO E CARDS
           ========================================= */
        .catalog-section { padding-bottom: 20px; }
        .product-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 16px;
        }

        .product-card {
            background: white; border-radius: var(--radius); padding: 12px;
            box-shadow: var(--shadow); display: flex; flex-direction: column;
            border: 2px solid #FFF3E0; position: relative; overflow: hidden;
            transition: transform 0.2s;
        }
        
        .product-card.sold-out { opacity: 0.8; background-color: #f5f5f5; border-color: #ddd; }
        .product-card.sold-out .product-img { filter: grayscale(100%); opacity: 0.6; }

        .sold-out-badge {
            position: absolute; top: 10px; right: 10px;
            background: var(--danger); color: white; font-size: 0.7rem; font-weight: bold;
            padding: 4px 8px; border-radius: 4px; z-index: 10; display: none;
        }
        .product-card.sold-out .sold-out-badge { display: block; }

        .product-img {
            height: 120px; background: #FFF8E1; border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 3.5rem; margin-bottom: 10px;
        }

        .product-info { flex-grow: 1; }
        .product-cat-tag { font-size: 0.7rem; text-transform: uppercase; color: #999; font-weight: bold; letter-spacing: 0.5px; }
        .product-name { font-size: 1rem; font-weight: 700; margin-bottom: 4px; line-height: 1.2; }
        .product-desc { font-size: 0.8rem; color: var(--text-light); margin-bottom: 8px; }
        .product-stock { font-size: 0.75rem; color: #777; margin-bottom: 5px; }
        .product-price { font-size: 1.2rem; color: var(--accent); font-weight: 800; }

        /* Controles + - */
        .user-controls {
            margin-top: 10px; background: #f4f4f4; border-radius: 12px;
            padding: 4px; display: flex; align-items: center; justify-content: space-between;
        }
        .qty-btn-card {
            width: 32px; height: 32px; background: white; border: 1px solid #ddd;
            border-radius: 8px; font-weight: bold; font-size: 1.2rem; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .qty-btn-card:active { background: #eee; }
        .qty-input-card { width: 30px; text-align: center; border: none; background: transparent; font-weight: bold; font-size: 1rem; }

        .add-cart-btn {
            width: 100%; margin-top: 10px; background: var(--primary);
            color: var(--text-main); border: none; padding: 12px;
            border-radius: 12px; font-weight: 700; cursor: pointer; transition: background 0.2s;
        }
        .add-cart-btn:active { transform: scale(0.98); background: var(--primary-dark); }
        .add-cart-btn:disabled { background: #ddd; color: #999; cursor: not-allowed; transform: none; }

        /* Painel Admin */
        .admin-panel {
            margin-top: 10px; padding-top: 10px; border-top: 1px dashed #ccc;
            display: none; flex-direction: column; gap: 5px;
        }
        .admin-active .admin-panel { display: flex; }
        .admin-row { display: flex; gap: 5px; }
        .admin-input { flex: 1; padding: 5px; border: 1px solid #ccc; text-align: center; border-radius: 4px;}
        .admin-btn { flex: 1; padding: 6px; font-size: 0.75rem; border: none; border-radius: 4px; cursor: pointer; color: white; font-weight: bold; }
        .btn-update { background: var(--primary-dark); }
        .btn-toggle { background: var(--danger); }
        .btn-toggle.active { background: var(--accent); }

        /* =========================================
           6. BOT√ÉO FLUTUANTE E CARRINHO
           ========================================= */
        .sticky-cart-btn {
            position: fixed; bottom: 20px; right: 20px;
            background-color: var(--text-main); color: var(--primary);
            padding: 15px 25px; border-radius: 50px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            display: flex; align-items: center; gap: 10px;
            font-weight: 800; z-index: 900; cursor: pointer;
            border: 2px solid var(--primary); transition: transform 0.2s;
        }
        .sticky-cart-btn:active { transform: scale(0.95); }
        
        .cart-count-badge {
            background: var(--danger); color: white; font-size: 0.8rem;
            width: 24px; height: 24px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
        }

        .cart-section {
            background: white; border-radius: var(--radius); padding: 20px;
            box-shadow: var(--shadow); margin-top: 20px; display: none;
        }
        .cart-section.open { display: block; animation: slideUp 0.3s; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .cart-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 0; border-bottom: 1px dashed #eee;
        }

        .client-form { margin-top: 20px; background: #FAFAFA; padding: 20px; border-radius: 12px; }
        .form-input { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; }
        .checkout-btn { width: 100%; padding: 15px; background: var(--accent); color: white; border: none; border-radius: 12px; font-weight: bold; font-size: 1.1rem; cursor: pointer; }

        /* =========================================
           7. RODAP√â E ADMIN LOGIN
           ========================================= */
        .footer { text-align: center; padding: 40px 20px; color: #888; font-size: 0.9rem; }
        .admin-login-area { margin-top: 20px; padding: 15px; border-top: 1px solid #eee; display: flex; justify-content: center; gap: 10px; }
        .admin-login-btn { background: transparent; color: #888; border: 1px solid #ccc; padding: 5px 15px; border-radius: 20px; cursor: pointer; font-size: 0.8rem; }
        .admin-login-form { display: none; gap: 5px; }
        .admin-login-form.show { display: flex; }

    </style>
</head>
<body>

    <div id="toast-container"></div>

    <div id="receiptModal" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-header">üìù Conferir Pedido</div>
            
            <div id="receiptText" class="receipt-paper">Carregando...</div>
            
            <div class="modal-actions">
                <button class="btn-modal btn-whatsapp" onclick="sendWhatsapp()">
                    üì≤ Enviar no WhatsApp
                </button>
                <button class="btn-modal btn-copy" onclick="copyReceipt()">
                    üìã Copiar Texto
                </button>
                <button class="btn-modal btn-close" onclick="closeReceipt()">
                    ‚ùå Voltar / Editar
                </button>
            </div>
        </div>
    </div>

    <header class="header">
        <div class="container">
            <h1 class="header-title">üßÄ Emp√≥rio do Queijo</h1>
            <p class="header-subtitle">Produtos da Ro√ßa & Sabores Artesanais</p>
        </div>
    </header>

    <div class="container">
        
        <section class="search-section">
            <input type="search" id="searchInput" class="search-input" placeholder="Buscar produtos...">
        </section>

        <section class="category-scroll">
            <div class="category-pill active" onclick="filterCategory('all', this)">Todos</div>
            <div class="category-pill" onclick="filterCategory('queijos', this)">Queijos</div>
            <div class="category-pill" onclick="filterCategory('doces', this)">Doces</div>
            <div class="category-pill" onclick="filterCategory('geleias', this)">Geleias</div>
            <div class="category-pill" onclick="filterCategory('laticinios', this)">Latic√≠nios</div>
            <div class="category-pill" onclick="filterCategory('petiscos', this)">Petiscos</div>
        </section>

        <section class="catalog-section">
            <div id="productGrid" class="product-grid"></div>
            <div id="noResults" style="display:none; text-align:center; padding: 40px; color:#999;">
                Nenhum produto encontrado nesta categoria.
            </div>
        </section>

        <section class="cart-section" id="cartSection">
            <h2 style="margin-bottom: 15px;">üõí Sua Cesta</h2>
            
            <div id="cartItemsContainer">
                <p style="text-align:center; color:#999;">Cesta vazia.</p>
            </div>

            <div style="text-align: right; font-size: 1.3rem; font-weight: 800; color: var(--accent); margin: 20px 0;">
                Total: <span id="cartTotalValue">R$ 0,00</span>
            </div>
            
            <button onclick="clearCart()" style="color: var(--danger); background:none; border:none; text-decoration:underline; cursor:pointer;">Esvaziar cesta</button>

            <div class="client-form">
                <h4 style="margin-bottom:10px;">Dados para entrega:</h4>
                <input type="text" id="clientName" class="form-input" placeholder="Seu Nome">
                <input type="tel" id="clientPhone" class="form-input" placeholder="Seu WhatsApp (com DDD)">
                <button class="checkout-btn" onclick="generateReceipt()">Concluir Pedido</button>
            </div>
        </section>

    </div>

    <div class="sticky-cart-btn" onclick="toggleCartView()">
        üõí <span class="cart-count-badge" id="floatingCartCount">0</span>
        <span style="font-size: 0.9rem;">Ver Cesta</span>
    </div>

    <footer class="footer">
        <p>&copy; 2026 Emp√≥rio do Queijo & Cia.</p>
        
        <div class="admin-login-area">
            <div id="adminLoginTrigger">
                <button class="admin-login-btn" onclick="showAdminForm()">√Årea do Lojista</button>
            </div>
            <div id="adminLoginForm" class="admin-login-form">
                <input type="password" id="adminPass" placeholder="Senha (admin)" style="padding: 5px; border-radius: 4px; border:1px solid #ccc;">
                <button onclick="loginAdmin()" style="background: var(--text-main); color: white; border:none; padding: 5px 10px; border-radius: 4px;">OK</button>
            </div>
            <div id="adminLogoutArea" style="display:none;">
                <span style="color: var(--accent); font-weight:bold;">Admin Ativo</span>
                <button onclick="logoutAdmin()" style="margin-left:10px; color: var(--danger); background:none; border:none; text-decoration:underline; cursor:pointer;">Sair</button>
            </div>
        </div>
    </footer>

    <script>
        // ==========================================
        // 0. CONFIGURA√á√ÉO ONLINE (JSONBIN)
        // ==========================================
        const BIN_ID = '696ad1eeae596e708fe18e2b'; 
        const API_KEY = '$2a$10$11iqh1McgX6s1NSao6L0W.71TsQU602UNg2yJFCzKKYcz1E7p8ZOK'; 
        const API_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;

        // ==========================================
        // 1. LISTA DE PRODUTOS COMPLETA
        // ==========================================
        const defaultProducts = [
            { id: 1, name: "Ovos (Pente 30 un)", category: "laticinios", price: 24.00, emoji: "ü•ö", desc: "Ovos frescos", stock: 20, soldOut: false },
            { id: 2, name: "Doce de Leite (Cubo)", category: "doces", price: 15.00, emoji: "üç¨", desc: "400g tradicional", stock: 15, soldOut: false },
            { id: 3, name: "Doce de Leite Cremoso", category: "doces", price: 15.00, emoji: "üçØ", desc: "400g pote", stock: 15, soldOut: false },
            { id: 4, name: "Doce de Leite com Coco", category: "doces", price: 15.00, emoji: "ü••", desc: "400g cremoso", stock: 10, soldOut: false },
            { id: 5, name: "Doce de Leite c/ Ameixa", category: "doces", price: 15.00, emoji: "üü£", desc: "400g cremoso", stock: 10, soldOut: false },
            { id: 6, name: "Requeij√£o de Corte", category: "queijos", price: 35.00, emoji: "üßÄ", desc: "Barra artesanal", stock: 10, soldOut: false },
            { id: 7, name: "Goiabada Casc√£o", category: "doces", price: 15.00, emoji: "üçò", desc: "Barra 500g", stock: 20, soldOut: false },
            { id: 8, name: "Bananinha Cristalizada", category: "doces", price: 7.00, emoji: "üçå", desc: "Pacote 200g", stock: 30, soldOut: false },
            { id: 9, name: "Manteiga", category: "laticinios", price: 28.00, emoji: "üßà", desc: "Pote da fazenda", stock: 12, soldOut: false },
            { id: 10, name: "Biscoito Caseiro", category: "petiscos", price: 7.00, emoji: "üç™", desc: "Pacote sortido", stock: 20, soldOut: false },
            { id: 11, name: "Geleia de Morango", category: "geleias", price: 35.00, emoji: "üçì", desc: "Pote 680g", stock: 8, soldOut: false },
            { id: 12, name: "Geleia de Jabuticaba", category: "geleias", price: 35.00, emoji: "üçá", desc: "Pote 680g", stock: 8, soldOut: false },
            { id: 13, name: "Geleia de Amora", category: "geleias", price: 35.00, emoji: "ü´ê", desc: "Pote 680g", stock: 8, soldOut: false },
            { id: 14, name: "Geleia de Uva", category: "geleias", price: 35.00, emoji: "üçá", desc: "Pote 680g", stock: 8, soldOut: false },
            { id: 15, name: "Mel Puro", category: "doces", price: 40.00, emoji: "üêù", desc: "Garrafa vidro", stock: 10, soldOut: false },
            { id: 16, name: "Queijo Artesanal", category: "queijos", price: 50.00, emoji: "üßÄ", desc: "Pe√ßa curada", stock: 10, soldOut: false },
            { id: 17, name: "Pururuca", category: "petiscos", price: 20.00, emoji: "ü•ì", desc: "Pacote crocante", stock: 15, soldOut: false },
            { id: 18, name: "Manteiga de Garrafa", category: "laticinios", price: 20.00, emoji: "üç∂", desc: "250ml (Peq)", stock: 10, soldOut: false }
        ];

        // ==========================================
        // 2. ESTADO DA APLICA√á√ÉO
        // ==========================================
        let products = [];
        let cart = [];
        let currentCategory = 'all';
        let generatedReceiptText = "";

        // ==========================================
        // 3. INICIALIZA√á√ÉO
        // ==========================================
        document.addEventListener('DOMContentLoaded', () => {
            loadDataOnline(); 
            // O renderCatalog ser√° chamado ap√≥s o loadDataOnline
        });

        // ==========================================
        // 4. FUN√á√ïES DE DADOS (ONLINE / FALLBACK)
        // ==========================================
        async function loadDataOnline() {
            showToast("Verificando estoque...", "info");
            
            // Verifica se o usu√°rio configurou as chaves (placeholder)
            if(BIN_ID.includes("COLE_SEU")) {
                console.log("Modo Offline (Sem chaves)");
                useLocalFallback();
                return;
            }

            try {
                const response = await fetch(API_URL + '/latest', {
                    headers: { 'X-Master-Key': API_KEY }
                });
                
                if (!response.ok) throw new Error("Erro de conex√£o");
                
                const data = await response.json();
                products = data.record; // JSONBin retorna em .record
                
                renderCatalog();
                updateCartUI();
                
            } catch (error) {
                console.error(error);
                useLocalFallback(); // Se falhar, usa os dados locais
            }
        }

        async function saveDataOnline() {
            if(BIN_ID.includes("696ad1eeae596e708fe18e2b")) return showToast("Erro: Configure o JSONBin no c√≥digo!", "error");

            showToast("Salvando nuvem...", "info");
            
            try {
                const response = await fetch(API_URL, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': API_KEY
                    },
                    body: JSON.stringify(products)
                });

                if (!response.ok) throw new Error("Erro ao salvar");
                showToast("Estoque salvo!", "success");
                
            } catch (error) {
                console.error(error);
                showToast("Erro ao salvar online.", "error");
            }
        }

        function useLocalFallback() {
            // Se n√£o tem internet ou chaves, usa a lista fixa
            products = JSON.parse(JSON.stringify(defaultProducts));
            renderCatalog();
        }

        // ==========================================
        // 5. L√ìGICA DE FILTRO (CATEGORIAS)
        // ==========================================
        function filterCategory(cat, element) {
            currentCategory = cat;
            
            document.querySelectorAll('.category-pill').forEach(el => el.classList.remove('active'));
            if(element) element.classList.add('active');
            
            document.getElementById('searchInput').value = '';
            renderCatalog();
        }

        document.getElementById('searchInput').addEventListener('input', () => renderCatalog());

        // ==========================================
        // 6. RENDERIZA√á√ÉO DO CAT√ÅLOGO
        // ==========================================
        function renderCatalog() {
            const grid = document.getElementById('productGrid');
            const term = document.getElementById('searchInput').value.toLowerCase();
            grid.innerHTML = '';
            let count = 0;

            if(!products || products.length === 0) {
                grid.innerHTML = '<p style="text-align:center; padding:20px;">Carregando...</p>';
                return;
            }

            products.forEach(p => {
                if (currentCategory !== 'all' && p.category !== currentCategory) return;
                if (term && !p.name.toLowerCase().includes(term)) return;

                count++;
                const isSoldOut = p.soldOut || p.stock <= 0;
                const btnTxt = isSoldOut ? 'Indispon√≠vel' : 'Adicionar √† Cesta';
                const toggleTxt = isSoldOut ? 'Reativar' : 'Esgotar';
                const toggleClass = isSoldOut ? 'active' : '';

                const html = `
                    <article class="product-card ${isSoldOut ? 'sold-out' : ''}">
                        <div class="sold-out-badge">ESGOTADO</div>
                        <div class="product-img">${p.emoji}</div>
                        
                        <div class="product-info">
                            <div class="product-cat-tag">${p.category}</div>
                            <div class="product-name">${p.name}</div>
                            <div class="product-desc">${p.desc}</div>
                            <div class="product-stock">Estoque: ${p.stock} un</div>
                            <div class="product-price">R$ ${p.price.toFixed(2).replace('.', ',')}</div>
                        </div>
                        
                        <div class="user-controls">
                            <button class="qty-btn-card" onclick="changeTempQty(${p.id}, -1)" ${isSoldOut?'disabled':''}>‚àí</button>
                            <input id="qty-sel-${p.id}" class="qty-input-card" value="1" readonly>
                            <button class="qty-btn-card" onclick="changeTempQty(${p.id}, 1)" ${isSoldOut?'disabled':''}>+</button>
                        </div>
                        
                        <button class="add-cart-btn" onclick="addToCart(${p.id})" ${isSoldOut?'disabled':''}>
                            ${btnTxt}
                        </button>

                        <div class="admin-panel">
                            <div class="admin-row">
                                <input type="number" id="stock-${p.id}" class="admin-input" value="${p.stock}">
                                <button class="admin-btn btn-update" onclick="adminUpdateStock(${p.id})">Salvar</button>
                            </div>
                            <button class="admin-btn btn-toggle ${toggleClass}" onclick="adminToggleStatus(${p.id})">${toggleTxt}</button>
                        </div>
                    </article>
                `;
                grid.innerHTML += html;
            });

            document.getElementById('noResults').style.display = count === 0 ? 'block' : 'none';
        }

        // ==========================================
        // 7. CARRINHO
        // ==========================================
        function changeTempQty(id, delta) {
            const el = document.getElementById(`qty-sel-${id}`);
            let val = parseInt(el.value) + delta;
            if(val < 1) val = 1;
            el.value = val;
        }

        function addToCart(id) {
            const p = products.find(x => x.id === id);
            const qtdInput = document.getElementById(`qty-sel-${id}`);
            const qtd = parseInt(qtdInput.value);

            if(p.soldOut || p.stock <= 0) return showToast('Produto esgotado!', 'error');

            const item = cart.find(x => x.id === id);
            const currentQtd = item ? item.qty : 0;

            if(currentQtd + qtd > p.stock) {
                return showToast(`Estoque insuficiente. Restam ${p.stock}`, 'error');
            }

            if(item) item.qty += qtd;
            else cart.push({...p, qty: qtd});

            qtdInput.value = 1; 
            updateCartUI();
            showToast('Adicionado √† cesta!', 'success');
        }

        function updateCartUI() {
            const container = document.getElementById('cartItemsContainer');
            const badge = document.getElementById('floatingCartCount');
            const totalEl = document.getElementById('cartTotalValue');
            
            container.innerHTML = '';
            let total = 0;
            let count = 0;

            if(cart.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#999; padding:20px;">Cesta vazia.</p>';
            } else {
                cart.forEach((item, idx) => {
                    total += item.price * item.qty;
                    count += item.qty;
                    container.innerHTML += `
                        <div class="cart-item">
                            <div>
                                <div style="font-weight:600">${item.name}</div>
                                <div style="font-size:0.85rem; color:#666">${item.qty}x R$ ${item.price.toFixed(2)}</div>
                            </div>
                            <div style="display:flex; align-items:center; gap:10px;">
                                <strong>R$ ${(item.qty*item.price).toFixed(2).replace('.',',')}</strong>
                                <button onclick="removeFromCart(${idx})" style="color:var(--danger); border:none; background:none; font-weight:bold;">‚úï</button>
                            </div>
                        </div>
                    `;
                });
            }

            badge.innerText = count;
            totalEl.innerText = 'R$ ' + total.toFixed(2).replace('.', ',');
        }

        function removeFromCart(idx) {
            cart.splice(idx, 1);
            updateCartUI();
        }

        function clearCart() {
            if(cart.length > 0 && confirm('Limpar toda a cesta?')) {
                cart = [];
                updateCartUI();
            }
        }

        function toggleCartView() {
            const el = document.getElementById('cartSection');
            if(el.style.display === 'block') {
                el.style.display = 'none';
                el.classList.remove('open');
            } else {
                el.style.display = 'block';
                el.classList.add('open');
                el.scrollIntoView({behavior:'smooth'});
            }
        }

        // ==========================================
        // 8. NOTA FISCAL (MODAL) E CHECKOUT
        // ==========================================
        function generateReceipt() {
            if (cart.length === 0) return showToast('Cesta vazia!', 'error');
            
            const name = document.getElementById('clientName').value.trim();
            const phone = document.getElementById('clientPhone').value.trim();

            if (!name || !phone) {
                showToast('Preencha Nome e WhatsApp!', 'error');
                document.querySelector('.client-form').scrollIntoView({behavior: 'smooth'});
                return;
            }

            let msg = `*PEDIDO - EMP√ìRIO DO QUEIJO*\n`;
            msg += `--------------------------------\n`;
            msg += `üë§ Cliente: ${name}\n`;
            msg += `üì± Contato: ${phone}\n`;
            msg += `üìÖ Data: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString().slice(0,5)}\n`;
            msg += `--------------------------------\n`;
            
            let total = 0;
            cart.forEach(item => {
                const sub = item.price * item.qty;
                msg += `[${item.qty}x] ${item.name}\n      R$ ${sub.toFixed(2).replace('.', ',')}\n`;
                total += sub;
            });
            
            msg += `--------------------------------\n`;
            msg += `*TOTAL: R$ ${total.toFixed(2).replace('.', ',')}*\n`;
            msg += `--------------------------------\n`;
            msg += `Aguardando confirma√ß√£o.`;

            generatedReceiptText = msg;
            document.getElementById('receiptText').innerText = generatedReceiptText;
            document.getElementById('receiptModal').classList.add('open');
        }

        function closeReceipt() {
            document.getElementById('receiptModal').classList.remove('open');
        }

        function sendWhatsapp() {
            const storePhone = "5513988534927"; 
            const url = `https://wa.me/${storePhone}?text=${encodeURIComponent(generatedReceiptText)}`;
            window.open(url, '_blank');
        }

        function copyReceipt() {
            navigator.clipboard.writeText(generatedReceiptText).then(() => showToast("Copiado!", 'success'));
        }

        // ==========================================
        // 9. ADMINISTRA√á√ÉO (COM JSONBIN)
        // ==========================================
        function showAdminForm() {
            document.getElementById('adminLoginTrigger').style.display = 'none';
            document.getElementById('adminLoginForm').classList.add('show');
        }

        function loginAdmin() {
            const pass = document.getElementById('adminPass').value;
            if (pass === 'admin') {
                document.body.classList.add('admin-active');
                document.getElementById('adminLoginForm').classList.remove('show');
                document.getElementById('adminLogoutArea').style.display = 'block';
                renderCatalog();
                showToast('Modo Lojista Ativo', 'info');
            } else {
                showToast('Senha inv√°lida', 'error');
            }
        }

        function logoutAdmin() {
            document.body.classList.remove('admin-active');
            document.getElementById('adminLogoutArea').style.display = 'none';
            document.getElementById('adminLoginTrigger').style.display = 'block';
            renderCatalog();
            showToast('Saiu do modo Lojista', 'info');
        }

        function adminUpdateStock(id) {
            const val = parseInt(document.getElementById(`stock-${id}`).value);
            const p = products.find(x => x.id === id);
            if(p) {
                p.stock = val;
                if(p.stock > 0 && p.soldOut) p.soldOut = false;
                if(p.stock <= 0) p.soldOut = true;
                
                saveDataOnline(); 
                renderCatalog();
            }
        }

        function adminToggleStatus(id) {
            const p = products.find(x => x.id === id);
            if(p) {
                p.soldOut = !p.soldOut;
                saveDataOnline();
                renderCatalog();
            }
        }

        // ==========================================
        // 10. UTILIT√ÅRIOS
        // ==========================================
        function showToast(msg, type='success') {
            const box = document.getElementById('toast-container');
            const el = document.createElement('div');
            el.className = `toast ${type}`;
            el.innerText = msg;
            box.appendChild(el);
            setTimeout(() => el.classList.add('visible'), 10);
            setTimeout(() => { 
                el.classList.remove('visible'); 
                setTimeout(()=>el.remove(), 300); 
            }, 3000);
        }
    </script>
</body>
</html>
